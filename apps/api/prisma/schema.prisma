generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Auth & User ─────────────────────────────────────────────────

model User {
  id                  String   @id @default(uuid())
  displayName         String   @db.VarChar(50)
  authProvider        String   @db.VarChar(10) // apple | google
  providerSubId       String   @unique @db.VarChar(255) // Zero-PII: provider's anonymous sub
  onboardingCompleted Boolean  @default(false)

  // Admin: role-based access control
  role                String   @default("user") @db.VarChar(20) // user | moderator | admin | superadmin

  // Phase 5B: UX preferences (DA-04)
  quietMode           Boolean  @default(false)
  timezone            String   @default("UTC") @db.VarChar(50) // IANA timezone, e.g. "Europe/Kyiv"
  locale              String   @default("en") @db.VarChar(10) // i18n locale, e.g. "en", "uk", "de"

  // Phase 6: GDPR two-domain identity (DA-10, designed now)
  publicId            String?  @unique @db.VarChar(16) // nanoid(16), generated on first social opt-in
  anonymized          Boolean  @default(false) // GDPR erasure flag

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  character           Character?
  progression         UserProgression?
  streak              Streak?
  roadmaps            Roadmap[]
  xpEvents            XPEvent[]
  refreshTokens       RefreshToken[]
  questCompletions    QuestCompletion[]
  reviewItems         ReviewItem[]
  achievementUnlocks  AchievementUnlock[]
  weeklyChallenges    WeeklyChallenge[]
  inventoryItems      InventoryItem[]
  forgeHistory        ForgeHistory[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

// ─── Character System ────────────────────────────────────────────

model Character {
  id             String   @id @default(uuid())
  userId         String   @unique
  characterId    String   @db.VarChar(20) // aria, kofi, mei, diego, zara, alex, priya, liam
  archetypeId    String   @db.VarChar(20) // strategist, explorer, connector, builder, innovator
  evolutionTier  String   @default("novice") @db.VarChar(20)
  companionId    String?  @db.VarChar(20)

  // 6 Attributes (0-100)
  mastery     Int @default(0)
  insight     Int @default(0)
  influence   Int @default(0)
  resilience  Int @default(0)
  versatility Int @default(0)
  discovery   Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  equipment CharacterEquipment[]

  @@map("characters")
}

model CharacterEquipment {
  id          String   @id @default(uuid())
  characterId String
  slot        String   @db.VarChar(20) // weapon, shield, armor, helmet, boots, ring, companion
  itemId      String   @db.VarChar(50)
  rarity      String   @default("common") @db.VarChar(20)
  equippedAt  DateTime @default(now())

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, slot])
  @@map("character_equipment")
}

// ─── Equipment Catalog (Phase 5F, SCD Type 2) ──────────────────

model EquipmentCatalog {
  id             String    @id @default(uuid())
  itemId         String    @unique @db.VarChar(60) // e.g. "weapon_common_blade_01"
  slot           String    @db.VarChar(20)  // weapon|shield|armor|helmet|boots|ring|companion
  rarity         String    @db.VarChar(20)  // common|uncommon|rare|epic|legendary
  name           String    @db.VarChar(100) // "Novice Blade"
  description    String    @db.Text
  attributeBonus Json      @default("{}") // { "MAS": 5, "INS": 2 }
  pixelArt       String?   @db.Text        // pixel art string key (nullable)
  isActive       Boolean   @default(true)
  validFrom      DateTime  @default(now()) // SCD Type 2
  validTo        DateTime?                 // null = current version
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([slot, rarity], name: "idx_equipment_catalog_slot_rarity")
  @@index([isActive], name: "idx_equipment_catalog_active")
  @@map("equipment_catalog")
}

model InventoryItem {
  id         String   @id @default(uuid())
  userId     String
  itemId     String   @db.VarChar(60) // FK → EquipmentCatalog.itemId
  slot       String   @db.VarChar(20)
  rarity     String   @db.VarChar(20)
  quantity   Int      @default(1)
  acquiredAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId], name: "uq_inventory_user_item")
  @@index([userId], name: "idx_inventory_user")
  @@map("inventory_item")
}

model ForgeHistory {
  id           String   @id @default(uuid())
  userId       String
  inputItems   Json     // [{ itemId, rarity }] × 3
  outputItemId String   @db.VarChar(60)
  outputRarity String   @db.VarChar(20)
  forgedAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], name: "idx_forge_history_user")
  @@map("forge_history")
}

// ─── Roadmap System ──────────────────────────────────────────────

model Roadmap {
  id           String   @id @default(uuid())
  userId       String
  title        String   @db.VarChar(200)
  goal         String   @db.Text
  description  String   @db.Text @default("")
  durationDays Int      @default(90)
  dailyMinutes Int      @default(30)
  status       String   @default("generating") @db.VarChar(20)
  progress     Float    @default(0) // 0-100
  aiModel      String   @default("claude-sonnet-4-6") @db.VarChar(50)
  locale       String   @default("en") @db.VarChar(10) // locale of generated content
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  milestones Milestone[]

  @@index([userId])
  @@map("roadmaps")
}

model Milestone {
  id          String   @id @default(uuid())
  roadmapId   String
  title       String   @db.VarChar(200)
  description String   @db.Text @default("")
  weekStart   Int
  weekEnd     Int
  order       Int
  status      String   @default("locked") @db.VarChar(20)
  progress    Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roadmap Roadmap @relation(fields: [roadmapId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@index([roadmapId])
  @@map("milestones")
}

model Task {
  id               String    @id @default(uuid())
  milestoneId      String
  title            String    @db.VarChar(200)
  description      String    @db.Text @default("")
  taskType         String    @db.VarChar(20) // video, article, quiz, project, review, boss
  estimatedMinutes Int       @default(15)
  xpReward         Int       @default(25)
  coinReward       Int       @default(5)
  rarity           String    @default("common") @db.VarChar(20)
  status           String    @default("locked") @db.VarChar(20)
  order            Int
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Phase 5C: Quest Engine v2 extensions (DA-05)
  questType        String    @default("knowledge") @db.VarChar(15)
  // ^ Validation type: "knowledge" | "physical" | "creative" | "habit" | "social" | "reflection"
  difficultyTier   Int       @default(1) // 1-5 challenge tier for AI Director
  requiredTimeSpent Int?     // minimum seconds before completion allowed (time-gating)
  knowledgeCheck   Json?     // quiz data: { question, options[], correctIndex, explanation }
  validationType   String    @default("knowledge_quiz") @db.VarChar(30)
  // ^ "knowledge_quiz" | "effort_reflection" | "artifact_declaration" |
  //   "completion_attestation" | "social_checkin" | "journal_entry"
  skillDomain      String?   @db.VarChar(50) // skill domain for diversity enforcement

  milestone        Milestone         @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  questCompletions QuestCompletion[]

  @@index([milestoneId])
  @@map("tasks")
}

// ─── Progression System ──────────────────────────────────────────

model UserProgression {
  id                String    @id @default(uuid())
  userId            String    @unique
  totalXp           Int       @default(0)
  level             Int       @default(1)
  coins             Int       @default(0)
  energyCrystals    Int       @default(3)
  maxEnergyCrystals Int       @default(3)
  subscriptionTier  String    @default("free") @db.VarChar(20)
  energyRechargeAt  DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_progressions")
}

model Streak {
  id               String    @id @default(uuid())
  userId           String    @unique
  currentStreak    Int       @default(0)
  longestStreak    Int       @default(0)

  // Phase 5A: Explicit state machine (DA-01)
  status           String    @default("active") @db.VarChar(10)
  // ^ "active" | "at_risk" | "frozen" | "broken"

  lastActivityDate DateTime  @default(now())
  freezesUsed      Int       @default(0) // resets weekly (free) or monthly (pro)
  freezesUsedMonth Int       @default(0) // monthly counter for Pro tier
  maxFreezes       Int       @default(1) // Free: 1/week, Pro: 4/month, Champion: unlimited
  frozenAt         DateTime? // when freeze was applied (for 3-day max)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("streaks")
}

model XPEvent {
  id         String   @id @default(uuid())
  userId     String
  amount     Int
  source     String   @db.VarChar(30) // task_complete, quiz_pass, boss_defeat, streak_bonus, etc.
  multiplier Float    @default(1.0)
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("xp_events")
}

// ─── Quest Completions (Phase 5A, DA-02) ─────────────────────────

model QuestCompletion {
  id               String   @id @default(uuid())
  userId           String
  taskId           String
  questType        String   @db.VarChar(15)
  // ^ "knowledge" | "physical" | "creative" | "habit" | "social" | "reflection"
  rarity           String   @db.VarChar(12)
  baseXp           Int
  bonusXp          Int      @default(0)
  qualityScore     Float?   // 0.0-1.0 engagement depth score
  validationResult Json     @default("{}")
  // ^ Type-specific validation data (quiz answers, effort rating, journal text)
  timeSpentSeconds Int?     // actual time from quest open to submit
  completedAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([userId, taskId]) // idempotency: one completion per user per task
  @@index([userId, completedAt]) // daily XP cap aggregation
  @@index([userId, questType]) // type diversity queries
  @@map("quest_completions")
}

// ─── Spaced Repetition (Phase 5D) ────────────────────────────────

model ReviewItem {
  id              String    @id @default(uuid())
  userId          String
  skillId         String    @db.VarChar(50)
  skillDomain     String?   @db.VarChar(50)
  easinessFactor  Float     @default(2.5)
  intervalDays    Int       @default(1)
  repetitionCount Int       @default(0)
  masteryLevel    Int       @default(0)
  nextReview      DateTime
  lastReviewedAt  DateTime?
  lastQuality     Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@index([userId, nextReview])
  @@index([userId, masteryLevel])
  @@map("review_items")
}

// ─── Achievements (Phase 5E) ─────────────────────────────────────

model AchievementUnlock {
  id            String   @id @default(uuid())
  userId        String
  achievementId String   @db.VarChar(50) // matches client-side ACHIEVEMENTS[].id
  xpAwarded     Int      @default(0)
  unlockedAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("achievement_unlocks")
}

// ─── Weekly Challenges (Phase 5E) ────────────────────────────────

model WeeklyChallenge {
  id           String    @id @default(uuid())
  userId       String
  weekStart    DateTime  // Monday 00:00 in user timezone
  type         String    @db.VarChar(30) // quest_volume, streak_guard, domain_focus, etc.
  difficulty   String    @db.VarChar(10) // easy, medium, hard
  targetValue  Int
  currentValue Int       @default(0)
  targetDomain String?   @db.VarChar(50)
  completed    Boolean   @default(false)
  completedAt  DateTime?
  xpReward     Int
  coinReward   Int
  createdAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, weekStart])
  @@map("weekly_challenges")
}
